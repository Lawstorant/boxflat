---
phase: 01-core-inversion-ui-behavior
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - boxflat/panels/others.py
autonomous: false

must_haves:
  truths:
    - "User can see Inverted Pedals toggle in Other settings panel"
    - "Toggle is visible only when pedals are connected"
    - "Toggle defaults to OFF (disabled) state"
    - "Toggle state persists to settings file when changed"
    - "Toggle dispatches inverted-pedals-enabled event on state change"
  artifacts:
    - path: "boxflat/panels/others.py"
      provides: "Inverted Pedals toggle in Other settings"
      contains: "BoxflatSwitchRow(\"Inverted Pedals\""
      exports: ["inverted-pedals-enabled event"]
  key_links:
    - from: "boxflat/panels/others.py"
      to: "~/.config/boxflat/settings.yml"
      via: "SettingsHandler.write_setting"
      pattern: "write_setting.*inverted-pedals"
    - from: "boxflat/panels/others.py"
      to: "HomeSettings, PedalsSettings"
      via: "EventDispatcher._dispatch"
      pattern: "_dispatch.*inverted-pedals-enabled"
    - from: "boxflat/panels/others.py"
      to: "MozaConnectionManager"
      via: "subscribe_connected"
      pattern: "subscribe_connected.*pedals-throttle-dir"
---

<objective>
Add the Inverted Pedals toggle to the Other settings panel with proper persistence, visibility control, and event dispatching.

Purpose: This is the foundational toggle that enables the entire Inverted Pedals feature. Other panels subscribe to its event to update their displays. The toggle must only appear when pedals are connected, persist its state, and dispatch events for other panels to consume.

Output: A working toggle switch in Other settings that saves to settings.yml and notifies other panels when state changes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-inversion-ui-behavior/01-CONTEXT.md
@.planning/phases/01-core-inversion-ui-behavior/01-RESEARCH.md
@boxflat/panels/others.py
@boxflat/settings_handler.py
@boxflat/subscription.py
</context>

<tasks>

<task type="auto">
  <name>Add Inverted Pedals toggle to Other settings panel</name>
  <files>boxflat/panels/others.py</files>
  <action>
    In `prepare_ui()` method, after the "Enable Moza detection fixes" row (after line 84):

    1. Create a new `BoxflatSwitchRow` with title "Inverted Pedals" and subtitle "Swap clutch and throttle axes"
    2. Store reference as `self._inverted_pedals_row`
    3. Register event "inverted-pedals-enabled" using `self._register_event()`
    4. Subscribe row to `self._settings.write_setting` with key "inverted-pedals"
    5. Subscribe row to dispatch event: `lambda v: self._dispatch("inverted-pedals-enabled", v)`
    6. Set initial value from settings: `self._settings.read_setting("inverted-pedals") or 0` (defaults to 0/disabled)
    7. Add the row to the panel with `self._add_row()`
    8. Subscribe to pedal connection visibility: `self._cm.subscribe_connected("pedals-throttle-dir", self._inverted_pedals_row.set_active, 1)`

    Follow the existing pattern from the brake calibration toggle (lines 67-74) and detection fixes toggle (lines 76-84).

    DO NOT modify any protocol, HID, or serial files - this is UI-layer only.
  </action>
  <verify>
    Run `grep -n "Inverted Pedals" boxflat/panels/others.py` to confirm the toggle was added.
    Run `grep -n "inverted-pedals-enabled" boxflat/panels/others.py` to confirm event registration.
  </verify>
  <done>
    The Inverted Pedals toggle appears in Other settings panel with:
    - Title: "Inverted Pedals"
    - Subtitle: "Swap clutch and throttle axes"
    - Default state: OFF (disabled)
    - Visible only when pedals are connected
    - Dispatches "inverted-pedals-enabled" event on toggle
    - Persists to "inverted-pedals" setting in settings.yml
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Inverted Pedals toggle in Other settings panel</what-built>
  <how-to-verify>
    1. Launch Boxflat application
    2. Navigate to "Other" settings panel
    3. Verify the "Inverted Pedals" toggle switch exists
    4. Verify the toggle is hidden when no pedals are connected
    5. Connect pedals (or have them connected) and verify toggle becomes visible
    6. Click the toggle to enable it
    7. Check that ~/.config/boxflat/settings.yml now contains "inverted-pedals: 1"
    8. Click the toggle to disable it
    9. Check that ~/.config/boxflat/settings.yml now contains "inverted-pedals: 0"
    10. Restart the application and verify the toggle state is preserved
  </how-to-verify>
  <resume-signal>Type "approved" if toggle works correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After implementation:
1. Settings file contains inverted-pedals key after toggling
2. Toggle visibility responds to pedal connection state
3. Toggle persists state across application restarts
4. Event dispatch occurs without errors (check journalctl if needed)
</verification>

<success_criteria>
1. Toggle appears in Other settings after brake calibration row
2. Toggle shows "Inverted Pedals" title and "Swap clutch and throttle axes" subtitle
3. Toggle defaults to OFF position on first launch
4. Toggle is hidden when no pedals are connected
5. Toggle becomes visible when pedals connect
6. Toggling writes to settings.yml under "inverted-pedals" key
7. Toggling dispatches "inverted-pedals-enabled" event
8. Restarting application preserves toggle state
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-inversion-ui-behavior/01-01-SUMMARY.md` with:
- Toggle implementation details (exact location in file)
- Event name confirmed: "inverted-pedals-enabled"
- Settings key confirmed: "inverted-pedals"
- Any deviations from plan or discovered issues
</output>
