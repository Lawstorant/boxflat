---
phase: 01-core-inversion-ui-behavior
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - boxflat/panels/pedals.py
autonomous: false

must_haves:
  truths:
    - "Pedals panel page titles update when inversion is toggled"
    - "Throttle page title shows 'Clutch' when inverted"
    - "Clutch page title shows 'Throttle' when inverted"
    - "Brake page title never changes"
    - "Star (U+2603) indicator appears on swapped pedal page titles"
  artifacts:
    - path: "boxflat/panels/pedals.py"
      provides: "Dynamic pedal page title updates on inversion toggle"
      contains: "_on_inverted_pedals_toggled"
      exports: ["_on_inverted_pedals_toggled callback"]
  key_links:
    - from: "boxflat/panels/pedals.py"
      to: "OtherSettings"
      via: "EventDispatcher.subscribe"
      pattern: "subscribe.*inverted-pedals-enabled"
    - from: "boxflat/panels/pedals.py"
      to: "Adw.NavigationPage"
      via: "set_title"
      pattern: "set_title.*Clutch|set_title.*Throttle"
---

<objective>
Update Pedals panel page titles to show swapped labels when Inverted Pedals is enabled.

Purpose: Users need to see which physical pedal is being configured on each page. When inverted, the Throttle page should show "Clutch *" and the Clutch page should show "Throttle *" so users understand the swap. Brake page remains unchanged.

Output: Pedals panel page titles that update dynamically when inversion state changes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@.planning/phases/01-core-inversion-ui-behavior/01-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-inversion-ui-behavior/01-CONTEXT.md
@.planning/phases/01-core-inversion-ui-behavior/01-RESEARCH.md
@boxflat/panels/pedals.py
@boxflat/panels/settings_panel.py
@boxflat/subscription.py
</context>

<tasks>

<task type="auto">
  <name>Add page reference storage and inversion event subscription to PedalsSettings</name>
  <files>boxflat/panels/pedals.py</files>
  <action>
    In `__init__` method:

    1. Add instance variable to track inversion state: `self._inverted = False`
    2. Add instance variable to store page references: `self._pedal_pages: dict[str, Gtk.Widget] = {}`

    In `prepare_ui()` method, at the END (after the for loop completes, around line 32):

    3. Subscribe to the inversion event from OtherSettings panel. Since PedalsSettings doesn't have direct access to OtherSettings, use app.py's event bridging pattern:
       - First, we need to store references to the preference pages so they can be updated later
       - Modify the `_prepare_pedal` method to store page references (see next task)

    Note: The event subscription will be handled by app.py bridging the event from OtherSettings to PedalsSettings. Add a callback method that can be subscribed externally.
  </action>
  <verify>
    Run `grep -n "_inverted\|_pedal_pages" boxflat/panels/pedals.py` to confirm instance variables were added.
  </verify>
  <done>
    PedalsSettings has instance variables for tracking inversion state and storing page references.
  </done>
</task>

<task type="auto">
  <name>Modify _prepare_pedal to store page references</name>
  <files>boxflat/panels/pedals.py</files>
  <action>
    In `_prepare_pedal()` method:

    1. After `self.add_preferences_page(pedal.name.title())` (line 35), store the page reference:
       ```python
       self._pedal_pages[pedal.name] = self._current_page
       ```
    2. The `self._current_page` is set by `add_preferences_page()` in the parent SettingsPanel class

    This stores the NavigationPage widget for each pedal so we can update its title later when inversion toggles.
  </action>
  <verify>
    Run `grep -n "_pedal_pages\[pedal.name\]" boxflat/panels/pedals.py` to confirm page storage was added.
  </verify>
  <done>
    Each pedal's NavigationPage is stored in _pedal_pages dict for later title updates.
  </done>
</task>

<task type="auto">
  <name>Add inversion callback method to update page titles</name>
  <files>boxflat/panels/pedals.py</files>
  <action>
    Add a new method `set_inverted_pedals(self, inverted: int)` to the PedalsSettings class:

    ```python
    def set_inverted_pedals(self, inverted: int) -> None:
        """Update pedal page titles when inversion state changes."""
        self._inverted = bool(inverted)

        # Update Throttle page title
        if MozaAxis.THROTTLE.name in self._pedal_pages:
            title = "Clughter" if self._inverted else "Throttle"
            title = f"{title} *" if self._inverted else title
            self._pedal_pages[MozaAxis.THROTTLE.name].set_title(title)

        # Update Clutch page title
        if MozaAxis.CLUTCH.name in self._pedal_pages:
            title = "Throttle" if self._inverted else "Clutch"
            title = f"{title} *" if self._inverted else title
            self._pedal_pages[MozaAxis.CLUTCH.name].set_title(title)

        # Brake page never changes - no update needed
    ```

    Note: The star indicator should be U+2603 or similar. Research document specifies star symbol. Use simple asterisk "*" for now as it's universally available.
  </action>
  <verify>
    Run `grep -n "set_inverted_pedals" boxflat/panels/pedals.py` to confirm the method was added.
  </verify>
  <done>
    PedalsSettings has a callable method that updates page titles based on inversion state.
  </done>
</task>

<task type="auto">
  <name>Bridge inversion event from OtherSettings to PedalsSettings in app.py</name>
  <files>boxflat/app.py</files>
  <action>
    In `_prepare_settings()` method (around line 297-321), add event bridging after line 321:

    ```python
    self._panels["Other"].subscribe("inverted-pedals-enabled", self._panels["Pedals"].set_inverted_pedals)
    ```

    This connects the event dispatched by OtherSettings toggle to the PedalsSettings callback.

    Also add initialization after line 321 to set the initial state:
    ```python
    initial_inverted = self._settings.read_setting("inverted-pedals") or 0
    self._panels["Pedals"].set_inverted_pedals(initial_inverted)
    ```
  </action>
  <verify>
    Run `grep -n "inverted-pedals-enabled" boxflat/app.py` to confirm event bridging was added.
  </verify>
  <done>
    Event from OtherSettings toggle is bridged to PedalsSettings, and initial state is set on startup.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Dynamic pedal page title updates in Pedals panel</what-built>
  <how-to-verify>
    1. Launch Boxflat application with pedals connected
    2. Navigate to "Pedals" panel
    3. Verify page titles are "Throttle", "Brake", "Clutch" (normal state)
    4. Navigate to "Other" settings panel
    5. Enable the "Inverted Pedals" toggle
    6. Return to "Pedals" panel
    7. Verify page titles are now "Clutch *", "Brake", "Throttle *"
    8. Disable the "Inverted Pedals" toggle
    9. Return to "Pedals" panel
    10. Verify page titles have returned to "Throttle", "Brake", "Clutch"
  </how-to-verify>
  <resume-signal>Type "approved" if page titles update correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After implementation:
1. Pedals page titles update instantly when toggle changes
2. Throttle and Clutch page titles swap when inverted
3. Star indicator appears on swapped pages
4. Brake page title never changes
5. No errors in journalctl related to page title updates
</verification>

<success_criteria>
1. Normal state: page titles are "Throttle", "Brake", "Clutch"
2. Inverted state: page titles are "Clutch *", "Brake", "Throttle *"
3. Toggling inversion updates titles immediately
4. Titles update without requiring panel navigation
5. Star indicator appears only on swapped pedal pages
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-inversion-ui-behavior/01-02-SUMMARY.md` with:
- Page title update implementation details
- Event bridging pattern used in app.py
- Star indicator character used
- Any deviations from plan or discovered issues
</output>
