---
phase: 01-core-inversion-ui-behavior
plan: 03
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - boxflat/panels/home.py
autonomous: false

must_haves:
  truths:
    - "Throttle input row title shows 'Clutch input *' when inverted"
    - "Clutch input row title shows 'Throttle input *' when inverted"
    - "Throttle input row displays clutch's physical value when inverted"
    - "Clutch input row displays throttle's physical value when inverted"
    - "Brake input row is unaffected by inversion"
    - "Row values and titles update instantly when toggle changes"
  artifacts:
    - path: "boxflat/panels/home.py"
      provides: "Swapped pedal input values and labels in Home panel"
      contains: "_inverted"
      exports: ["set_inverted_pedals callback", "_throttle_input_wrapper", "_clutch_input_wrapper"]
  key_links:
    - from: "boxflat/panels/home.py"
      to: "OtherSettings"
      via: "EventDispatcher.subscribe (bridged in app.py)"
      pattern: "subscribe.*inverted-pedals-enabled"
    - from: "boxflat/panels/home.py"
      to: "HidHandler"
      via: "subscribe (original HID subscriptions)"
      pattern: "_hid_handler\.subscribe.*THROTTLE|_hid_handler\.subscribe.*CLUTCH"
---

<objective>
Implement value and label swapping for throttle/clutch input rows in the Home panel when Inverted Pedals is enabled.

Purpose: Users need to see the correct physical pedal values when inversion is active. The Throttle input row should show clutch's physical value (and be labeled "Clutch input *"), while the Clutch input row should show throttle's physical value (and be labeled "Throttle input *"). Brake is unaffected.

Output: Home panel pedal input rows that display swapped values and labels based on inversion state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@.planning/phases/01-core-inversion-ui-behavior/01-01-SUMMARY.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-inversion-ui-behavior/01-CONTEXT.md
@.planning/phases/01-core-inversion-ui-behavior/01-RESEARCH.md
@boxflat/panels/home.py
@boxflat/widgets/min_max_level_row.py
@boxflat/hid_handler.py
@boxflat/subscription.py
</context>

<tasks>

<task type="auto">
  <name>Add inversion state tracking and row reference storage to HomeSettings</name>
  <files>boxflat/panels/home.py</files>
  <action>
    In `__init__` method:

    1. Add instance variable to track inversion state: `self._inverted = False`
    2. Add instance variables to store row references:
       ```python
       self._throttle_row = None
       self._clutch_row = None
       ```

    These will be used to:
    - Update row titles when inversion toggles
    - Route values to the correct rows in wrapper functions
  </action>
  <verify>
    Run `grep -n "_inverted\|_throttle_row\|_clutch_row" boxflat/panels/home.py` to confirm instance variables were added.
  </verify>
  <done>
    HomeSettings has instance variables for inversion state and row references.
  </done>
</task>

<task type="auto">
  <name>Store row references and create wrapper callback methods</name>
  <files>boxflat/panels/home.py</files>
  <action>
    In `prepare_ui()` method:

    1. After creating the Throttle input row (line 51), store the reference:
       ```python
       self._throttle_row = self._current_row
       ```

    2. After creating the Clutch input row (line 59), store the reference:
       ```python
       self._clutch_row = self._current_row
       ```

    3. Add two wrapper callback methods after the `_set_limit` method (around line 92):

       ```python
       def _throttle_input_wrapper(self, value: int) -> None:
           """Route throttle value to correct row based on inversion state."""
           if self._inverted:
               # Inverted: route throttle value to clutch row
               self._clutch_row.set_value(value)
           else:
               # Normal: route throttle value to throttle row
               self._throttle_row.set_value(value)

       def _clutch_input_wrapper(self, value: int) -> None:
           """Route clutch value to correct row based on inversion state."""
           if self._inverted:
               # Inverted: route clutch value to throttle row
               self._throttle_row.set_value(value)
           else:
               # Normal: route clutch value to clutch row
               self._clutch_row.set_value(value)
       ```

    Note: We'll keep the original HID subscriptions and just redirect their outputs through the wrappers. The wrappers will be updated in the next task.
  </action>
  <verify>
    Run `grep -n "_throttle_input_wrapper\|_clutch_input_wrapper" boxflat/panels/home.py` to confirm wrapper methods were added.
  </verify>
  <done>
    Row references are stored and wrapper callback methods exist for value routing.
  </done>
</task>

<task type="auto">
  <name>Update HID subscriptions to use wrapper callbacks</name>
  <files>boxflat/panels/home.py</files>
  <action>
    In `prepare_ui()` method, modify the HID subscriptions for throttle and clutch:

    1. Change line 52 from:
       ```python
       self._hid_handler.subscribe(MozaAxis.THROTTLE.name, self._current_row.set_value)
       ```
       To:
       ```python
       self._hid_handler.subscribe(MozaAxis.THROTTLE.name, self._throttle_input_wrapper)
       ```

    2. Change line 60 from:
       ```python
       self._hid_handler.subscribe(MozaAxis.CLUTCH.name, self._current_row.set_value)
       ```
       To:
       ```python
       self._hid_handler.subscribe(MozaAxis.CLUTCH.name, self._clutch_input_wrapper)
       ```

    Leave the Brake subscription unchanged (line 56) - brake is never affected by inversion.

    The wrappers now receive the raw HID values and route them to the correct row based on inversion state.
  </action>
  <verify>
    Run `grep -n "subscribe.*_throttle_input_wrapper\|subscribe.*_clutch_input_wrapper" boxflat/panels/home.py` to confirm subscriptions use wrappers.
  </verify>
  <done>
    HID events for throttle and clutch are routed through wrapper functions that check inversion state.
  </done>
</task>

<task type="auto">
  <name>Add inversion callback method to update row titles</name>
  <files>boxflat/panels/home.py</files>
  <action>
    Add a new method `set_inverted_pedals(self, inverted: int) -> None` to the HomeSettings class:

    ```python
    def set_inverted_pedals(self, inverted: int) -> None:
        """Update pedal input row titles when inversion state changes."""
        self._inverted = bool(inverted)

        # Update Throttle row title
        if self._throttle_row:
            title = "Clutch input" if self._inverted else "Throttle input"
            title = f"{title} *" if self._inverted else title
            self._throttle_row.set_title(title)

        # Update Clutch row title
        if self._clutch_row:
            title = "Throttle input" if self._inverted else "Clutch input"
            title = f"{title} *" if self._inverted else title
            self._clutch_row.set_title(title)

        # Brake row is never affected - no update needed
    ```

    The star indicator (*) shows the row is displaying a swapped axis.
  </action>
  <verify>
    Run `grep -n "set_inverted_pedals" boxflat/panels/home.py` to confirm the method was added.
  </verify>
  <done>
    HomeSettings has a callable method that updates row titles based on inversion state.
  </done>
</task>

<task type="auto">
  <name>Bridge inversion event from OtherSettings to HomeSettings in app.py</name>
  <files>boxflat/app.py</files>
  <action>
    In `_prepare_settings()` method (around line 297-321), add event bridging after the PedalsSettings bridging (added in plan 02):

    ```python
    self._panels["Other"].subscribe("inverted-pedals-enabled", self._panels["Home"].set_inverted_pedals)
    ```

    Also add initialization after the PedalsSettings initialization to set the initial state:
    ```python
    self._panels["Home"].set_inverted_pedals(initial_inverted)
    ```

    This uses the same `initial_inverted` variable that was set for PedalsSettings.

    Note: Multiple subscriptions to the same event ("inverted-pedals-enabled") are supported - both HomeSettings and PedalsSettings will receive the event.
  </action>
  <verify>
    Run `grep -n "inverted-pedals-enabled" boxflat/app.py` to confirm event bridging includes Home panel.
  </verify>
  <done>
    Event from OtherSettings toggle is bridged to HomeSettings, and initial state is set on startup.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Swapped pedal input values and labels in Home panel</what-built>
  <how-to-verify>
    1. Launch Boxflat application with pedals connected
    2. Navigate to "Home" panel
    3. Note the current values for throttle and clutch (press each pedal to see values)
    4. Note the row titles are "Throttle input", "Brake input", "Clutch input"
    5. Navigate to "Other" settings panel
    6. Enable the "Inverted Pedals" toggle
    7. Return to "Home" panel
    8. Verify row titles are now "Clutch input *", "Brake input", "Throttle input *"
    9. Press the physical throttle pedal
    10. Verify the "Clutch input *" row shows the value (values are swapped)
    11. Press the physical clutch pedal
    12. Verify the "Throttle input *" row shows the value (values are swapped)
    13. Disable the "Inverted Pedals" toggle
    14. Verify row titles and values return to normal
  </how-to-verify>
  <resume-signal>Type "approved" if values and labels swap correctly, or describe issues</resume-signal>
</task>

</tasks>

<verification>
After implementation:
1. Row titles update instantly when toggle changes
2. Throttle input row shows clutch's physical value when inverted
3. Clutch input row shows throttle's physical value when inverted
4. Brake input row is never affected
5. Value swapping happens at UI layer only (HID subscriptions unchanged)
6. No errors in journalctl related to value routing
</verification>

<success_criteria>
1. Normal state: "Throttle input" shows throttle value, "Clutch input" shows clutch value
2. Inverted state: "Clutch input *" shows throttle value, "Throttle input *" shows clutch value
3. Toggling inversion updates both titles and value routing immediately
4. Physical pedal inputs display correctly in swapped rows
5. Brake input row never changes
6. Star indicator appears on swapped input rows
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-inversion-ui-behavior/01-03-SUMMARY.md` with:
- Value routing wrapper implementation details
- Event bridging pattern in app.py
- Confirmation of UI-layer only implementation
- Any deviations from plan or discovered issues
</output>
